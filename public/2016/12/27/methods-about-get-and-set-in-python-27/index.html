<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.proxy.ustclug.org/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="python," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />






<meta name="description" content="Python 中有很多关于 get/set 的魔术方法和内置方法，在官方文档中描述的相对分散，这里做个简单的总结。">
<meta name="keywords" content="python">
<meta property="og:type" content="article">
<meta property="og:title" content="Python 2.7 中 GET&#x2F;SET 相关的方法">
<meta property="og:url" content="http://blog.sevenplus.me/2016/12/27/methods-about-get-and-set-in-python-27/index.html">
<meta property="og:site_name" content="HakurouKen 的博客">
<meta property="og:description" content="Python 中有很多关于 get/set 的魔术方法和内置方法，在官方文档中描述的相对分散，这里做个简单的总结。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2016-12-27T17:57:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python 2.7 中 GET&#x2F;SET 相关的方法">
<meta name="twitter:description" content="Python 中有很多关于 get/set 的魔术方法和内置方法，在官方文档中描述的相对分散，这里做个简单的总结。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: false,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.sevenplus.me/2016/12/27/methods-about-get-and-set-in-python-27/"/>





  <title> Python 2.7 中 GET/SET 相关的方法 | HakurouKen 的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">HakurouKen 的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">A coder.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.sevenplus.me/2016/12/27/methods-about-get-and-set-in-python-27/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="HakurouKen">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="HakurouKen 的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="HakurouKen 的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Python 2.7 中 GET/SET 相关的方法
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-27T21:35:40+08:00">
                2016-12-27
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Python 中有很多关于 get/set 的魔术方法和内置方法，在官方文档中描述的相对分散，这里做个简单的总结。</p>
<a id="more"></a>
<h2 id="旧式类-经典类-和新式类"><a href="#旧式类-经典类-和新式类" class="headerlink" title="旧式类(经典类)和新式类"></a>旧式类(经典类)和新式类</h2><p>由于历史原因，Python 中的类分为旧式类(old-style class)和在 Python 2.2 中引入的新式类(new-style class),引入这个新式类的目的主要是为了统一类(class)和类型(type)。简单的说来，对于新式类中的 <code>x</code> 实例，有<code>type(x) == x.__class__</code>（在旧式类中二者不一致）。另外，新式类中为对象提供了一套完整的“元模型”（对纯 Python 代码而言，就是一系列的魔术方法），使新式类的功能更强大。<strong>下文讨论的所有 magic-method 全部针对新式类。</strong><br>新旧式类的主要区别示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OldStyleClass</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">old_instance = OldStyleClass()</span><br><span class="line"><span class="comment"># 旧式类中 type(o) 和 o.__class__ 的返回并不一样</span></span><br><span class="line">type(old_instance) <span class="comment"># type('instance')</span></span><br><span class="line">old_instance.__class__ <span class="comment"># &lt;class __main__.OldStyleClass at 0x005F0A40&gt;</span></span><br><span class="line"><span class="comment"># 旧式类的对象中，并不包含 __getattribute__ 这种 magic-method</span></span><br><span class="line">dir(old_instance) <span class="comment"># ['__doc__', '__module__']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承自 object 的类就是新式类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewStyleClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 新式类也可以使用元类创建，不过在实际编码中不推荐</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnotherNewStyleClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    __metaclass__ = type</span><br><span class="line"></span><br><span class="line">new_instance = NewStyleClass()</span><br><span class="line">type(new_instance) <span class="comment"># &lt;class '__main__.NewStyleClass'&gt;</span></span><br><span class="line">new_instance.__class__ <span class="comment"># &lt;class '__main__.NewStyleClass'&gt;</span></span><br><span class="line">dir(new_instance) <span class="comment"># ['__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__',...]</span></span><br></pre></td></tr></table></figure></p>
<p>更多有关旧式类和新式类的区别，可以参照 <a href="https://docs.python.org/2/reference/datamodel.html#new-style-and-classic-classes" target="_blank" rel="noopener">Python 的官方文档</a>。<br>在实际开发中，建议全部使用新式类。另外，在 Python3 中，已经去掉了旧式类的概念，全部都是新式类。</p>
<h2 id="魔术方法和内置方法"><a href="#魔术方法和内置方法" class="headerlink" title="魔术方法和内置方法"></a>魔术方法和内置方法</h2><h3 id="object-getattribute"><a href="#object-getattribute" class="headerlink" title="object.__getattribute__"></a><code>object.__getattribute__</code></h3><p>在获取对象的 <strong>任意</strong> 属性时 <strong>无条件</strong> 执行。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(object)</span>:</span></span><br><span class="line">    ANCIENT = <span class="string">'ape'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,sex,age=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.sex = sex</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">growup</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.age += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Try to get attribute: `&#123;&#125;`.'</span>.format(name)</span><br><span class="line">        <span class="comment"># 这里不能使用 self.name, 否则会导致循环递归，抛出 RuntimeError</span></span><br><span class="line">        <span class="keyword">return</span> object.__getattribute__(self,name)</span><br><span class="line"></span><br><span class="line">person = Person(<span class="string">'male'</span>)</span><br><span class="line"><span class="keyword">assert</span>(person.sex == <span class="string">'male'</span>)</span><br><span class="line"><span class="comment"># 这里直接取了 sex 变量，输出:</span></span><br><span class="line"><span class="comment">#   Try to get attribute: `sex`.</span></span><br><span class="line">person.growup()</span><br><span class="line"><span class="comment"># 这里直接取了 growup 变量，在 growup 内又取了 age 变量，因此输出：</span></span><br><span class="line"><span class="comment">#   Try to get attribute: `growup`.</span></span><br><span class="line"><span class="comment">#   Try to get attribute `age`.</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    person.haha</span><br><span class="line"><span class="keyword">except</span> AttributeError <span class="keyword">as</span> err:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Got an AttributeError'</span></span><br><span class="line"><span class="comment"># 取了不存在的变量 haha，也会触发 __getattribute__</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment">#   Try to get attribute `haha`.</span></span><br><span class="line"><span class="comment">#   Got an AttributeError</span></span><br><span class="line"><span class="keyword">assert</span>(person.ANCIENT == <span class="string">'ape'</span>)</span><br><span class="line"><span class="comment"># 获取类变量时，__getattribute__ 也会触发</span></span><br><span class="line"><span class="comment"># 输出：</span></span><br><span class="line"><span class="comment">#   Try to get attribute `ANCIENT`</span></span><br><span class="line"><span class="keyword">assert</span>(Person.ANCIENT == <span class="string">'ape'</span>)</span><br><span class="line"><span class="comment"># __getattribute__ 是对象的属性，从类直接获取类变量，不会调用，没有输出</span></span><br><span class="line"><span class="keyword">assert</span>(person.__class__ == Person)</span><br><span class="line"><span class="comment"># 取内部变量时，__getattribute__ 也会触发</span></span><br><span class="line"><span class="comment"># 输出:</span></span><br><span class="line"><span class="comment">#   Try to get attribute `__class__`</span></span><br></pre></td></tr></table></figure></p>
<p><code>__getattribute__</code> 是相对底层的方法，在实际开发中，很少涉及到(并且也 <strong>不建议</strong> )对其进行重载。如果修改默认的 <code>__getattribute__</code>，也会对 <code>__getattr__</code> 和描述符的调用产生影响。另外需要注意的是，<code>__getattribute__</code> 没有与之对应的 set 方法。</p>
<h3 id="object-getattr-和-object-setattr"><a href="#object-getattr-和-object-setattr" class="headerlink" title="object.__getattr__ 和 object.__setattr__"></a><code>object.__getattr__</code> 和 <code>object.__setattr__</code></h3><p><code>__getattr__</code> 在获取对象的属性，且该属性不存在时调用（<code>__getattribute__</code>抛出 <code>AttributeError</code> 时调用）。<br>例如，我们打算创建一个 “用点号访问的字典类型” 的类：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DotDict</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,**data)</span>:</span></span><br><span class="line">        self._data = data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"__getattr__ called, name: `&#123;&#125;`"</span>.format(name)</span><br><span class="line">        <span class="keyword">return</span> self._data.get(name)</span><br><span class="line"></span><br><span class="line">obj = DotDict(key=<span class="string">'value'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(obj.kwargs == &#123;<span class="string">'key'</span>:<span class="string">'value'</span>&#125;)</span><br><span class="line"><span class="comment"># 对于对象已有的属性，不会执行 __getattr__ ,这里没有任何输出</span></span><br><span class="line"><span class="keyword">assert</span>(obj.key == <span class="string">'value'</span>)</span><br><span class="line"><span class="comment"># key 不是 obj的一个属性，会调用 __getattr__ ,输出：</span></span><br><span class="line"><span class="comment">#   __getattr__ called, name: `key`</span></span><br></pre></td></tr></table></figure></p>
<p>另外，如果重写了 <code>__getattribute__</code> 方法，导致其不抛出 <code>AttributeError</code>(正常返回，或抛出其它错误)，都会导致 <code>__getattr__</code> 不执行。<br><code>__setattr__</code> 是在为对象设定属性值时即会被调用。需要注意的是，这个触发时机和 <code>__getattr__</code> 并 <strong>不对称</strong>（却和 <code>__getattribute__</code>类似）。<br>与 <code>__getattribute__</code>类似，我们不能在 <code>__setattr__</code> 中使用类似 <code>self.name = value</code> 这样的语句，否则会导致死循环。<br>我们为上面的 <code>DotDict</code> 完善一个 set 方法如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DotDict</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,**data)</span>:</span></span><br><span class="line">        <span class="comment"># 这里如果写 self._data = data , 会导致死循环</span></span><br><span class="line">        <span class="comment"># 需要改成调用 object 的 __setattr__ 方法</span></span><br><span class="line">        super(DotDict,self).__setattr__(<span class="string">'_data'</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"__getattr__ : &#123;&#125;"</span>.format(name)</span><br><span class="line">        <span class="keyword">return</span> self._data.get(name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self,name,value)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"__setattr__: &#123;&#125; = &#123;&#125;"</span>.format(name,value)</span><br><span class="line">        self._data[name] = value</span><br><span class="line"></span><br><span class="line">obj = DotDict()</span><br><span class="line"><span class="comment"># obj.key 触发 __getattr__ 调用，输出：</span></span><br><span class="line"><span class="comment">#   __getattr__ : key</span></span><br><span class="line"><span class="keyword">assert</span>(obj.key == <span class="keyword">None</span>)</span><br><span class="line"><span class="comment"># 为 obj 对象设置值，触发 __setattr__, 输出：</span></span><br><span class="line"><span class="comment">#   __setattr__: key = value</span></span><br><span class="line">obj.key = <span class="string">'value'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="getattr-和-setattr-以及-hasattr"><a href="#getattr-和-setattr-以及-hasattr" class="headerlink" title="getattr 和 setattr (以及 hasattr)"></a><code>getattr</code> 和 <code>setattr</code> (以及 <code>hasattr</code>)</h3><p><code>getattr</code> 、<code>setattr</code> 和 <code>hastattr</code> 是 Python 的内置函数，他们的表现比较直观:<br>在不给定 default 时，<code>getattr(object, name[, default])</code> 表现和 <code>object.name</code> 一致。<br>给定 default 后，则会将 default 当作属性不存在（即抛出 <code>AttributeError</code>）时的默认值。<br><code>setattr(object, name, value)</code> 和 <code>object.name = value</code> 表现一致。<br><code>hasattr(object, name)</code> 的表现可以用下列的 Python 代码描述：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hasattr_</span><span class="params">(obj, name)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        getattr(obj, name)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure></p>
<h3 id="get-，-set-和描述器-Descriptor"><a href="#get-，-set-和描述器-Descriptor" class="headerlink" title="__get__ ， __set__ 和描述器(Descriptor)"></a><code>__get__</code> ， <code>__set__</code> 和描述器(Descriptor)</h3><p>在 Python 中，描述器是指一个访问控制(可以简单理解为getter/setter)被对应的协议方法重写的 <strong>对象属性</strong>。这里的“访问控制”对应的魔术方法有 <code>__get__(self, obj, type=None)</code>, <code>__set__(self, obj, value)</code> 和 <code>__delete__(self, obj)</code>。其中定义了 <code>__get__</code> 和 <code>__set__</code> 的方法叫做 <strong>资料描述器(data descriptor)</strong>, 只定义了 <code>__get__</code> 的方法叫做 <strong>非资料描述器(non-data descriptor)</strong>。<br>对于 <code>obj.attr</code>，如果寻找到的 <code>attr</code> 属性定义了 <code>__get__</code> 方法，则会按照 <strong>资料描述器 -&gt; 实例变量 -&gt; 非资料描述器 -&gt; <strong>getattr</strong> （如果有）</strong> 的顺序来查找执行。<br>描述器的概念相对抽象，这里看一个官方给的描述器的例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RevealAccess</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""A data descriptor that sets and returns values</span></span><br><span class="line"><span class="string">       normally and prints a message logging their access.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initval=None, name=<span class="string">'var'</span>)</span>:</span></span><br><span class="line">        self.val = initval</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, objtype)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Retrieving'</span>, self.name</span><br><span class="line">        <span class="keyword">return</span> self.val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, val)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Updating'</span>, self.name</span><br><span class="line">        self.val = val</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    x = RevealAccess(<span class="number">10</span>, <span class="string">'var "x"'</span>)</span><br><span class="line">    y = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">m = MyClass()</span><br><span class="line"><span class="keyword">assert</span>(m.x == <span class="number">10</span>) <span class="comment"># 输出： Retrieving var "x"</span></span><br><span class="line">m.x = <span class="number">20</span> <span class="comment"># 输出： Updating var "x"</span></span><br><span class="line"><span class="keyword">assert</span>(m.x == <span class="number">20</span>) <span class="comment"># 输出： Retrieving var "x"</span></span><br><span class="line"><span class="keyword">assert</span>(m.y == <span class="number">5</span>) <span class="comment"># y 不是一个描述器，没有输出</span></span><br></pre></td></tr></table></figure></p>
<p>描述器在 Python 内应用相当广泛，比如常用的 property/staticmethod/classmethod 内部都使用了描述器。更多关于描述器的详细介绍，可以参照<a href="https://docs.python.org/2/howto/descriptor.html" target="_blank" rel="noopener">官方文档</a> ，或其<a href="http://pyzh.readthedocs.io/en/latest/Descriptor-HOW-TO-Guide.html" target="_blank" rel="noopener">中文译本</a>。</p>
<h3 id="getitem-setitem-和-contain"><a href="#getitem-setitem-和-contain" class="headerlink" title="__getitem__ , __setitem__ 和 __contain__"></a><code>__getitem__</code> , <code>__setitem__</code> 和 <code>__contain__</code></h3><p>这两个魔术方法和其它的魔术方法比较好区分，因为它们是作用于容器类型（例如 <code>dict/tuple/list</code>）,在 <code>self[key]</code> 时调用。比如 <code>list</code> 中的负索引的实现，就是使用了 <code>__getitem__</code> 的方法。这里需要注意，内置的 <code>dict/tuple/list</code> 等的这个方法不能被直接修改。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Language</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.languages = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, language)</span>:</span></span><br><span class="line">        ver = self.languages.get(language)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ver:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'There is no language named &#123;&#125;.'</span>.format(language)</span><br><span class="line">        <span class="keyword">return</span> self.languages.get(language)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, language, version)</span>:</span></span><br><span class="line">        old_version = self.languages.get(language)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Language update from version &#123;&#125; to &#123;&#125;'</span>.format(old_version <span class="keyword">or</span> <span class="number">0</span>,version)</span><br><span class="line">        self.languages[language] = version</span><br><span class="line"></span><br><span class="line">lang = Language()</span><br><span class="line"><span class="keyword">assert</span>(lang[<span class="string">'python'</span>] == <span class="keyword">None</span>)</span><br><span class="line"><span class="comment"># 输出: There is no language named python.</span></span><br><span class="line">lang[<span class="string">'python'</span>] = <span class="string">'2.7'</span></span><br><span class="line"><span class="comment"># 输出： Language update from version None to 0 to 2.7</span></span><br><span class="line">lang[<span class="string">'python'</span>] = <span class="string">'3.6'</span></span><br><span class="line"><span class="comment"># 输出： Language update from version None to 2.7 to 3.6</span></span><br><span class="line"><span class="keyword">assert</span>(lang[<span class="string">'python'</span>] == <span class="string">'3.6'</span>)</span><br><span class="line"><span class="comment"># 没有输出</span></span><br></pre></td></tr></table></figure></p>
<p>当我们使用 <code>in</code> 时，会优先调用 <code>__contain__</code> 方法，如果没有则使用 <code>__iter__</code>，最后尝试 <code>__getitem__</code>。</p>
<h2 id="Python-中的点号调用"><a href="#Python-中的点号调用" class="headerlink" title="Python 中的点号调用"></a>Python 中的点号调用</h2><p>Python 中的点号调用，主要的逻辑集中在 <code>__getattribute__</code> ，在 <code>__getattribute__</code> 执行完毕后，只需要根据是否抛出 <code>AttributeError</code> 判断是否执行 <code>__getattr__</code>（如果有），之后即可得到最终结果。下文主要描述 <code>__getattribute__</code> 的内部实现。</p>
<h3 id="getattribute-的执行过程"><a href="#getattribute-的执行过程" class="headerlink" title="__getattribute__ 的执行过程"></a><code>__getattribute__</code> 的执行过程</h3><p>先上结论：<br>下面讨论的过程，<strong>只针对于非内建属性</strong>，内建属性(例如<code>__doc__</code>)将会直接从 slot 中取，这里不列入考虑。对于对象<code>object.__getattribute__</code> 和类<code>type.__getattribute__</code>处理方式稍微有些不同。</p>
<p>对于对象，Python 查找 <code>obj.attr_name</code> 的过程如下:</p>
<ol>
<li>沿着 MRO 寻找 <code>attr_name</code> 对应的值（并保存下结果<code>descr</code>），如果 <code>descr</code> 是资料描述器，执行<code>__get__(obj,type(obj))</code>并返回。</li>
<li>在 <code>obj.__dict__</code> 中寻找对象属性，如果寻找到了，返回（这里找到的值就是实例变量）。</li>
<li>如果在 步骤1 中 <code>descr</code> 为非资料描述器，执行<code>__get__(obj,type(obj))</code>并返回。</li>
<li>在 步骤1 中 <code>descr</code> 不是个描述器，直接返回（这里就是类变量）。</li>
<li>什么都没找到，抛出 <code>AttributeError</code>。</li>
</ol>
<p>对于类，Python 查找 <code>Cls.attr_name</code> 和对象类似，具体的过程如下：</p>
<ol>
<li>沿着 MRO 寻找 <code>attr_name</code> 对应的值（并保存下这个结果 <code>meta_attribute</code>），如果是资料描述器，执行 <code>__get__(Cls,type(Cls))</code>并返回。</li>
<li>在 <code>Cls.__dict__</code> 中寻找对象属性：<ol>
<li>如果找到了属性，且属性为描述器，执行 <code>__get__(None,Cls)</code> 并返回结果。</li>
<li>如果找到了属性，且属性不是描述器，返回结果。</li>
<li>如果没找到属性，继续。</li>
</ol>
</li>
<li>如果在 步骤1 中的 <code>meta_attribute</code> 为非资料描述器，执行 <code>__get__(Cls, type(Cls))</code> 并返回。</li>
<li>在 步骤1 <code>meta_attribute</code> 中找到的不是描述器，直接返回。</li>
<li>什么都没找到，抛出 <code>AttributeError</code>。</li>
</ol>
<p>可以看到，对象和类的不同处理方式主要在 <code>__dict__</code> 中找到的值如果是描述器，需不需要再做处理。<br>上文中多次提到了 MRO （Method Resolution Order)，这是在 Python 中解决多重继承中同名函数二义性的一种算法。对于单继承的情况，我们可以简单理解为一层一层向父级寻找。MRO相关的参考资料，可以参考 The History of Python 中的 <a href="http://python-history.blogspot.com/2010/06/method-resolution-order.html" target="_blank" rel="noopener">Method Resolution Order</a>。</p>
<h3 id="getattribute-在-CPython-中的实现"><a href="#getattribute-在-CPython-中的实现" class="headerlink" title="__getattribute__ 在 CPython 中的实现"></a><code>__getattribute__</code> 在 CPython 中的实现</h3><p>首先看对于对象的实现，在 Python 的官方提供的 <a href="https://docs.python.org/2/c-api/object.html#c.PyObject_GetAttr" target="_blank" rel="noopener">C-API</a> 中，我们可以看到上层的 Python 代码<code>o.attr_name</code> 对应 CPython 中底层 C 代码的 <code>PyObject* PyObject_GetAttr(PyObject *o, PyObject *attr_name)</code>。<br><code>PyObject_GetAttr</code> 的完整代码如下(在 <code>Objects/object.c</code>)：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PyObject *</span><br><span class="line">PyObject_GetAttr(PyObject *v, PyObject *name)</span><br><span class="line">&#123;</span><br><span class="line">    PyTypeObject *tp = Py_TYPE(v);</span><br><span class="line">    <span class="comment">/* 省略了一些字符串/unicode 校验代码 */</span></span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;tp_getattro != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> (*tp-&gt;tp_getattro)(v, name);</span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;tp_getattr != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> (*tp-&gt;tp_getattr)(v, PyString_AS_STRING(name));</span><br><span class="line">    PyErr_Format(PyExc_AttributeError,</span><br><span class="line">                 <span class="string">"'%.50s' object has no attribute '%.400s'"</span>,</span><br><span class="line">                 tp-&gt;tp_name, PyString_AS_STRING(name));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Py_TYPE</code> 是一个宏定义，实质是将对象转 <code>PyObject</code> 后取 <code>ob_type</code>（参见 <code>Include/object.h</code>）。这里的 <code>ob_type</code> 被称作元类，是一个 <code>PyTypeObject</code> 的指针。对于一个 <code>object</code> 对象，可以见到它的完整定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">PyTypeObject PyBaseObject_Type = &#123;</span><br><span class="line">    PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="number">0</span>)</span><br><span class="line">    <span class="string">"object"</span>,                                   <span class="comment">/* tp_name */</span></span><br><span class="line">    <span class="keyword">sizeof</span>(PyObject),                           <span class="comment">/* tp_basicsize */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_itemsize */</span></span><br><span class="line">    object_dealloc,                             <span class="comment">/* tp_dealloc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_print */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_getattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_setattr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_compare */</span></span><br><span class="line">    object_repr,                                <span class="comment">/* tp_repr */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_number */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_sequence */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_mapping */</span></span><br><span class="line">    (hashfunc)_Py_HashPointer,                  <span class="comment">/* tp_hash */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_call */</span></span><br><span class="line">    object_str,                                 <span class="comment">/* tp_str */</span></span><br><span class="line">    PyObject_GenericGetAttr,                    <span class="comment">/* tp_getattro */</span></span><br><span class="line">    PyObject_GenericSetAttr,                    <span class="comment">/* tp_setattro */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_as_buffer */</span></span><br><span class="line">    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE, <span class="comment">/* tp_flags */</span></span><br><span class="line">    PyDoc_STR(<span class="string">"The most base type"</span>),            <span class="comment">/* tp_doc */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_traverse */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_clear */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_richcompare */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_weaklistoffset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iter */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_iternext */</span></span><br><span class="line">    object_methods,                             <span class="comment">/* tp_methods */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_members */</span></span><br><span class="line">    object_getsets,                             <span class="comment">/* tp_getset */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_base */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dict */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_get */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_descr_set */</span></span><br><span class="line">    <span class="number">0</span>,                                          <span class="comment">/* tp_dictoffset */</span></span><br><span class="line">    object_init,                                <span class="comment">/* tp_init */</span></span><br><span class="line">    PyType_GenericAlloc,                        <span class="comment">/* tp_alloc */</span></span><br><span class="line">    object_new,                                 <span class="comment">/* tp_new */</span></span><br><span class="line">    PyObject_Del,                               <span class="comment">/* tp_free */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在这里，我们需要关注的就是 <code>PyObject_GenericGetAttr</code> 这个函数。<code>__getattribute__</code> 的核心逻辑就是在这个函数中完成的。在 Python 的 <a href="https://docs.python.org/2/c-api/object.html#c.PyObject_GenericGetAttr" target="_blank" rel="noopener">C-API</a> 中也解释了它的功能：在对象的 MRO 中类的字典中查询对应的描述符，并在 <code>__dict__</code> 中查询对应属性（如果存在的话），然后按照 资料描述器 -&gt; 实例属性 -&gt; 非示例属性的顺序获取属性。如果都没有，则会引发 <code>AttributeError</code>。<br>下文的代码演示在 Python 2.7.13 源代码的基础上做了改动，省略掉了一些校验和 <code>PyObject_GenericGetAttr</code> 调用 <code>_PyObject_GenericGetAttrWithDict</code> 中不会走到的代码流程。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generic GetAttr functions - put these in your tp_[gs]etattro slot */</span></span><br><span class="line">PyObject *</span><br><span class="line">PyObject_GenericGetAttr(PyObject *obj, PyObject *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> _PyObject_GenericGetAttrWithDict(obj, name, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PyObject *</span><br><span class="line">_PyObject_GenericGetAttrWithDict(PyObject *obj, PyObject *name, PyObject *dict)</span><br><span class="line">&#123;</span><br><span class="line">    PyTypeObject *tp = Py_TYPE(obj);</span><br><span class="line">    PyObject *descr = <span class="literal">NULL</span>;</span><br><span class="line">    PyObject *res = <span class="literal">NULL</span>;</span><br><span class="line">    descrgetfunc f;</span><br><span class="line">    Py_ssize_t dictoffset;</span><br><span class="line">    PyObject **dictptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 这里省略掉了 PyString_Check 相关的校验代码 */</span></span><br><span class="line"></span><br><span class="line">    Py_INCREF(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果 __dict__ 不存在，判断是否初始化，如果初始化失败，直接抛异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;tp_dict == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PyType_Ready(tp) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * _PyType_Lookup 是一个沿着 MRO 搜索对应名称的内部 API，源代码说明如下：</span></span><br><span class="line"><span class="comment">     * Internal API to look for a name through the MRO.</span></span><br><span class="line"><span class="comment">     * This returns a borrowed reference, and doesn't set an exception!</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    descr = _PyType_Lookup(tp, name);</span><br><span class="line">    Py_XINCREF(descr);</span><br><span class="line"></span><br><span class="line">    f = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* 如果找到了对应的描述器， 且描述器是资料描述器的话， 执行该描述器的 __get__，结束 */</span></span><br><span class="line">    <span class="keyword">if</span> (descr != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        PyType_HasFeature(descr-&gt;ob_type, Py_TPFLAGS_HAVE_CLASS)) &#123;</span><br><span class="line">        f = descr-&gt;ob_type-&gt;tp_descr_get;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="literal">NULL</span> &amp;&amp; PyDescr_IsData(descr)) &#123;</span><br><span class="line">            res = f(descr, obj, (PyObject *)obj-&gt;ob_type);</span><br><span class="line">            Py_DECREF(descr);</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 由于传入的 dict 为 NULL，这里一定会进入这个分支。</span></span><br><span class="line"><span class="comment">     * 可以看出，这里的操作就是把指针移到 __dict__ 区域对应的区域</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">if</span> (dict == <span class="literal">NULL</span>) &#123;</span><br><span class="line">         <span class="comment">/* Inline _PyObject_GetDictPtr */</span></span><br><span class="line">         dictoffset = tp-&gt;tp_dictoffset;</span><br><span class="line">         <span class="keyword">if</span> (dictoffset != <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (dictoffset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                 Py_ssize_t tsize;</span><br><span class="line">                 <span class="keyword">size_t</span> size;</span><br><span class="line"></span><br><span class="line">                 tsize = ((PyVarObject *)obj)-&gt;ob_size;</span><br><span class="line">                 <span class="keyword">if</span> (tsize &lt; <span class="number">0</span>)</span><br><span class="line">                     tsize = -tsize;</span><br><span class="line">                 size = _PyObject_VAR_SIZE(tp, tsize);</span><br><span class="line"></span><br><span class="line">                 dictoffset += (<span class="keyword">long</span>)size;</span><br><span class="line">                 assert(dictoffset &gt; <span class="number">0</span>);</span><br><span class="line">                 assert(dictoffset % SIZEOF_VOID_P == <span class="number">0</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             dictptr = (PyObject **) ((<span class="keyword">char</span> *)obj + dictoffset);</span><br><span class="line">             dict = *dictptr;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * 如果有 __dict__ ，直接取对应的 name ，取到就返回。</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">if</span> (dict != <span class="literal">NULL</span>) &#123;</span><br><span class="line">         Py_INCREF(dict);</span><br><span class="line">         res = PyDict_GetItem(dict, name);</span><br><span class="line">         <span class="keyword">if</span> (res != <span class="literal">NULL</span>) &#123;</span><br><span class="line">             Py_INCREF(res);</span><br><span class="line">             Py_XDECREF(descr);</span><br><span class="line">             Py_DECREF(dict);</span><br><span class="line">             <span class="keyword">goto</span> done;</span><br><span class="line">         &#125;</span><br><span class="line">         Py_DECREF(dict);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 上文已经对资料描述器做了处理，这里处理非资料描述器 */</span></span><br><span class="line">    <span class="keyword">if</span> (f != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        res = f(descr, obj, (PyObject *)Py_TYPE(obj));</span><br><span class="line">        Py_DECREF(descr);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* f == NULL , 说明沿 MRO 搜索到的是普通属性，直接把它返回 */</span></span><br><span class="line">    <span class="keyword">if</span> (descr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        res = descr;</span><br><span class="line">        <span class="comment">/* descr was already increfed above */</span></span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 上述查找全都失败，抛出 AttributeError */</span></span><br><span class="line">    PyErr_Format(PyExc_AttributeError,</span><br><span class="line">                 <span class="string">"'%.50s' object has no attribute '%.400s'"</span>,</span><br><span class="line">                 tp-&gt;tp_name, PyString_AS_STRING(name));</span><br><span class="line">  done:</span><br><span class="line">    Py_DECREF(name);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此，<code>__getattribute__</code> 的过程结束。</p>
<p>对于类，大体和对象是一致的，只不过 <code>PyObject_GenericGetAttr</code> 变成了 <code>type_getattro</code>，如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 官方注释也说，它们两个差不多... */</span></span><br><span class="line"><span class="comment">/* This is similar to PyObject_GenericGetAttr(),</span></span><br><span class="line"><span class="comment">   but uses _PyType_Lookup() instead of just looking in type-&gt;tp_dict. */</span></span><br><span class="line"><span class="keyword">static</span> PyObject *</span><br><span class="line">type_getattro(PyTypeObject *type, PyObject *name)</span><br><span class="line">&#123;</span><br><span class="line">    PyTypeObject *metatype = Py_TYPE(type);</span><br><span class="line">    PyObject *meta_attribute, *attribute;</span><br><span class="line">    descrgetfunc meta_get;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!PyString_Check(name)) &#123;</span><br><span class="line">        PyErr_Format(PyExc_TypeError,</span><br><span class="line">                     <span class="string">"attribute name must be string, not '%.200s'"</span>,</span><br><span class="line">                     name-&gt;ob_type-&gt;tp_name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize this type (we'll assume the metatype is initialized) */</span></span><br><span class="line">    <span class="keyword">if</span> (type-&gt;tp_dict == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PyType_Ready(type) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No readable descriptor found yet */</span></span><br><span class="line">    meta_get = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Look for the attribute in the metatype */</span></span><br><span class="line">    meta_attribute = _PyType_Lookup(metatype, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (meta_attribute != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        meta_get = Py_TYPE(meta_attribute)-&gt;tp_descr_get;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (meta_get != <span class="literal">NULL</span> &amp;&amp; PyDescr_IsData(meta_attribute)) &#123;</span><br><span class="line">            <span class="comment">/* Data descriptors implement tp_descr_set to intercept</span></span><br><span class="line"><span class="comment">             * writes. Assume the attribute is not overridden in</span></span><br><span class="line"><span class="comment">             * type's tp_dict (and bases): call the descriptor now.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> meta_get(meta_attribute, (PyObject *)type,</span><br><span class="line">                            (PyObject *)metatype);</span><br><span class="line">        &#125;</span><br><span class="line">        Py_INCREF(meta_attribute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No data descriptor found on metatype. Look in tp_dict of this</span></span><br><span class="line"><span class="comment">     * type and its bases */</span></span><br><span class="line">    attribute = _PyType_Lookup(type, name);</span><br><span class="line">    <span class="keyword">if</span> (attribute != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* Implement descriptor functionality, if any */</span></span><br><span class="line">        descrgetfunc local_get = Py_TYPE(attribute)-&gt;tp_descr_get;</span><br><span class="line"></span><br><span class="line">        Py_XDECREF(meta_attribute);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (local_get != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* NULL 2nd argument indicates the descriptor was</span></span><br><span class="line"><span class="comment">             * found on the target object itself (or a base)  */</span></span><br><span class="line">            <span class="keyword">return</span> local_get(attribute, (PyObject *)<span class="literal">NULL</span>,</span><br><span class="line">                             (PyObject *)type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Py_INCREF(attribute);</span><br><span class="line">        <span class="keyword">return</span> attribute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No attribute found in local __dict__ (or bases): use the</span></span><br><span class="line"><span class="comment">     * descriptor from the metatype, if any */</span></span><br><span class="line">    <span class="keyword">if</span> (meta_get != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        PyObject *res;</span><br><span class="line">        res = meta_get(meta_attribute, (PyObject *)type,</span><br><span class="line">                       (PyObject *)metatype);</span><br><span class="line">        Py_DECREF(meta_attribute);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If an ordinary attribute was found on the metatype, return it now */</span></span><br><span class="line">    <span class="keyword">if</span> (meta_attribute != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> meta_attribute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Give up */</span></span><br><span class="line">    PyErr_Format(PyExc_AttributeError,</span><br><span class="line">                     <span class="string">"type object '%.50s' has no attribute '%.400s'"</span>,</span><br><span class="line">                     type-&gt;tp_name, PyString_AS_STRING(name));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>官方文档 / HOWTO：</p>
<ul>
<li><a href="https://docs.python.org/2/library/functions.html" target="_blank" rel="noopener">Python 内建函数</a> <code>getattr</code> 和 <code>setattr</code></li>
<li><a href="https://docs.python.org/2/reference/datamodel.html" target="_blank" rel="noopener">Python 中的数据模型</a></li>
<li><a href="https://docs.python.org/2/library/stdtypes.html#internal-objects" target="_blank" rel="noopener">Python 中的内建类型</a> <code>Internal-Objects</code></li>
<li><a href="https://docs.python.org/2/reference/expressions.html#membership-test-details" target="_blank" rel="noopener">Python 中 in 操作符</a></li>
<li><a href="https://docs.python.org/2/c-api/type.html" target="_blank" rel="noopener">CPython-API 类型对象(PyTypeObject)</a></li>
<li><a href="https://docs.python.org/2/c-api/object.html" target="_blank" rel="noopener">CPython 对象协议</a></li>
<li><a href="https://docs.python.org/2/howto/descriptor.html" target="_blank" rel="noopener">Python 描述器 HowTo</a></li>
</ul>
<p>Stackoverflow:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/14787334/confused-with-getattribute-and-setattribute-in-python#answer-14787522" target="_blank" rel="noopener">Python getattribute and setattribute </a></li>
<li><a href="http://stackoverflow.com/questions/24863787/python-the-getattribute-method-and-descriptors#answer-24863898" target="_blank" rel="noopener">Python <code>__getattribute__</code> method and descriptors</a></li>
<li><a href="http://stackoverflow.com/questions/1944625/what-is-the-relationship-between-getattr-and-getattr" target="_blank" rel="noopener">Python <code>__getattr__</code> 与 <code>getattr</code></a></li>
</ul>
<p>其它：</p>
<ul>
<li><a href="http://pyzh.readthedocs.io/en/latest/Descriptor-HOW-TO-Guide.html" target="_blank" rel="noopener">Python 描述器 HowTo 翻译</a></li>
<li><a href="http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue6/a-guide-to-pythons-magic-methods.html" target="_blank" rel="noopener">Python 魔术方法指南</a></li>
<li><a href="http://blog.jidanke.com/2015/04/21/python-attribute-lookup/" target="_blank" rel="noopener">python 属性查找</a></li>
<li>The History of Python 中的 <a href="http://python-history.blogspot.com/2010/06/method-resolution-order.html" target="_blank" rel="noopener">Method Resolution Order</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/15/thoughts-and-improvement-on-django-router/" rel="next" title="对 Django URL 路由机制的思考与改进">
                <i class="fa fa-chevron-left"></i> 对 Django URL 路由机制的思考与改进
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/29/future-package-in-python/" rel="prev" title="Python 中的 __future__ 模块">
                Python 中的 __future__ 模块 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="HakurouKen" />
          <p class="site-author-name" itemprop="name">HakurouKen</p>
          <p class="site-description motion-element" itemprop="description">↑ P站ID=55398733</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives/">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#旧式类-经典类-和新式类"><span class="nav-number">1.</span> <span class="nav-text">旧式类(经典类)和新式类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#魔术方法和内置方法"><span class="nav-number">2.</span> <span class="nav-text">魔术方法和内置方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#object-getattribute"><span class="nav-number">2.1.</span> <span class="nav-text">object.__getattribute__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#object-getattr-和-object-setattr"><span class="nav-number">2.2.</span> <span class="nav-text">object.__getattr__ 和 object.__setattr__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattr-和-setattr-以及-hasattr"><span class="nav-number">2.3.</span> <span class="nav-text">getattr 和 setattr (以及 hasattr)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-，-set-和描述器-Descriptor"><span class="nav-number">2.4.</span> <span class="nav-text">__get__ ， __set__ 和描述器(Descriptor)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getitem-setitem-和-contain"><span class="nav-number">2.5.</span> <span class="nav-text">__getitem__ , __setitem__ 和 __contain__</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Python-中的点号调用"><span class="nav-number">3.</span> <span class="nav-text">Python 中的点号调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getattribute-的执行过程"><span class="nav-number">3.1.</span> <span class="nav-text">__getattribute__ 的执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattribute-在-CPython-中的实现"><span class="nav-number">3.2.</span> <span class="nav-text">__getattribute__ 在 CPython 中的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        

<div class="busuanzi-count" id="busuanzi_container_site_pv" style="display:none;">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  

</div>



        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-flask"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HakurouKen</span>
</div>

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js"></script>

  <script type="text/javascript" src="/js/src/motion.js"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js"></script>
<script type="text/javascript" src="/js/src/post-details.js"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
